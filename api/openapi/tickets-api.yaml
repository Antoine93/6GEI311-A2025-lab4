openapi: 3.0.3
info:
  title: Ticket Management System API
  description: |
    API REST pour le système de gestion de tickets - 6GEI311 Lab 4

    Cette API permet de gérer un système de tickets avec :
    - Gestion des utilisateurs (User, Admin)
    - CRUD complet sur les tickets
    - Gestion des commentaires
    - Transitions de statut validées
    - Export PDF
    - Authentification et permissions

    Architecture basée sur les patterns :
    - Composite (contenu riche : texte, image, vidéo)
    - Strategy (export PDF)
    - Observer (notifications de changements)
    - MVC (séparation View-Controller-Model)
  version: 1.0.0
  contact:
    name: 6GEI311 - Antoine Larouche Tremblay
    email: altrembla3@etu.uqac.ca

servers:
  - url: http://localhost:8080/api/v1
    description: Serveur de développement local

tags:
  - name: auth
    description: Authentification et gestion de session
  - name: users
    description: Gestion des utilisateurs
  - name: tickets
    description: Gestion des tickets (CRUD)
  - name: comments
    description: Gestion des commentaires
  - name: status
    description: Gestion des statuts et transitions
  - name: export
    description: Export de tickets

# ============================================================================
# SCHÉMAS DE DONNÉES (Phase 1.2)
# ============================================================================

components:
  schemas:
    # ------------------------------------------------------------------------
    # Schéma UserDTO
    # ------------------------------------------------------------------------
    UserDTO:
      type: object
      description: Représentation d'un utilisateur du système
      required:
        - userID
        - name
        - role
        - isAdmin
      properties:
        userID:
          type: integer
          format: int32
          description: Identifiant unique de l'utilisateur
          example: 1
        name:
          type: string
          description: Nom complet de l'utilisateur
          minLength: 1
          maxLength: 100
          example: "Utilisateur1"
        email:
          type: string
          format: email
          description: Adresse email de l'utilisateur
          example: "utilisateur1@uqac.ca"
        role:
          type: string
          description: Rôle de l'utilisateur dans le système
          enum:
            - Admin
            - Developpeur
            - Testeur
            - Utilisateur
          example: "Developpeur"
        isAdmin:
          type: boolean
          description: Indique si l'utilisateur a les privilèges admin
          example: false

    # ------------------------------------------------------------------------
    # Schéma TicketDTO
    # ------------------------------------------------------------------------
    TicketDTO:
      type: object
      description: Représentation complète d'un ticket
      required:
        - ticketID
        - title
        - status
        - priority
        - creationDate
      properties:
        ticketID:
          type: integer
          format: int32
          description: Identifiant unique du ticket
          example: 1001
        title:
          type: string
          description: Titre du ticket
          minLength: 1
          maxLength: 200
          example: "Bug critique - Crash à la connexion"
        status:
          type: string
          description: Statut actuel du ticket
          enum:
            - Ouvert
            - Assigne
            - En validation
            - Termine
            - Ferme
          example: "Ouvert"
        priority:
          type: string
          description: Niveau de priorité du ticket
          enum:
            - Critique
            - Haute
            - Moyenne
            - Basse
          example: "Haute"
        createdByName:
          type: string
          description: Nom de l'utilisateur qui a créé le ticket
          example: "Utilisateur1"
        assignedToName:
          type: string
          description: Nom de l'utilisateur assigné (null si non assigné)
          nullable: true
          example: "Utilisateur2"
        description:
          type: string
          description: Description textuelle du ticket (affichage simplifié)
          example: "[TEXTE] L'application crash lors de la connexion..."
        descriptionContent:
          type: array
          description: Description structurée (pattern Composite)
          items:
            $ref: '#/components/schemas/ContentItemDTO'
        creationDate:
          type: string
          format: date-time
          description: Date et heure de création du ticket
          example: "2025-11-16T10:30:00Z"
        updateDate:
          type: string
          format: date-time
          description: Date et heure de dernière modification
          example: "2025-11-16T14:45:00Z"

    # ------------------------------------------------------------------------
    # Schéma ContentItemDTO (Pattern Composite)
    # ------------------------------------------------------------------------
    ContentItemDTO:
      type: object
      description: |
        Représentation d'un élément de contenu (texte, image, vidéo).
        Implémente le pattern Composite côté API.
      required:
        - type
        - data
      properties:
        type:
          type: string
          description: Type de contenu
          enum:
            - TEXT
            - IMAGE
            - VIDEO
          example: "TEXT"
        data:
          type: string
          description: |
            Données du contenu :
            - Pour TEXT : le texte complet
            - Pour IMAGE : chemin du fichier image
            - Pour VIDEO : chemin du fichier vidéo
          example: "L'application crash lors de la connexion après 3 tentatives échouées."
        metadata:
          type: string
          description: |
            Métadonnées optionnelles :
            - Pour TEXT : null ou vide
            - Pour IMAGE : caption/légende
            - Pour VIDEO : durée en secondes (format string)
          nullable: true
          example: "Message d'erreur affiché lors du crash"

    # ------------------------------------------------------------------------
    # Schéma CommentDTO
    # ------------------------------------------------------------------------
    CommentDTO:
      type: object
      description: Représentation d'un commentaire sur un ticket
      required:
        - commentID
        - ticketID
        - text
        - createdAt
      properties:
        commentID:
          type: integer
          format: int32
          description: Identifiant unique du commentaire
          example: 1
        ticketID:
          type: integer
          format: int32
          description: ID du ticket associé
          example: 1001
        text:
          type: string
          description: Texte du commentaire
          minLength: 1
          maxLength: 1000
          example: "Investigation en cours - logs analysés"
        authorName:
          type: string
          description: Nom de l'auteur du commentaire
          example: "Utilisateur1"
        createdAt:
          type: string
          format: date-time
          description: Date et heure de création du commentaire
          example: "2025-11-16T11:00:00Z"

    # ------------------------------------------------------------------------
    # Schéma StatusUpdateDTO
    # ------------------------------------------------------------------------
    StatusUpdateDTO:
      type: object
      description: Requête de changement de statut d'un ticket
      required:
        - newStatus
      properties:
        newStatus:
          type: string
          description: Nouveau statut souhaité (validation des transitions côté serveur)
          enum:
            - OUVERT
            - ASSIGNE
            - VALIDATION
            - TERMINE
            - FERME
          example: "ASSIGNE"

    # ------------------------------------------------------------------------
    # Schéma AssignmentDTO
    # ------------------------------------------------------------------------
    AssignmentDTO:
      type: object
      description: Requête d'assignation d'un ticket à un utilisateur
      required:
        - userID
      properties:
        userID:
          type: integer
          format: int32
          description: ID de l'utilisateur à qui assigner le ticket
          example: 2

    # ------------------------------------------------------------------------
    # Schémas pour la création/modification de tickets
    # ------------------------------------------------------------------------
    CreateTicketRequest:
      type: object
      description: Requête de création d'un nouveau ticket
      required:
        - title
        - priority
        - descriptionContent
      properties:
        title:
          type: string
          description: Titre du ticket
          minLength: 1
          maxLength: 200
          example: "Bug critique - Crash à la connexion"
        priority:
          type: string
          description: Niveau de priorité
          enum:
            - Critique
            - Haute
            - Moyenne
            - Basse
          example: "Haute"
        descriptionContent:
          type: array
          description: Éléments de contenu (pattern Composite)
          minItems: 1
          items:
            $ref: '#/components/schemas/ContentItemDTO'

    UpdateTicketRequest:
      type: object
      description: Requête de modification d'un ticket existant
      properties:
        title:
          type: string
          description: Nouveau titre (optionnel)
          minLength: 1
          maxLength: 200
          example: "Bug critique - Crash à la connexion [RÉSOLU]"
        priority:
          type: string
          description: Nouvelle priorité (optionnel)
          enum:
            - Critique
            - Haute
            - Moyenne
            - Basse
          example: "Moyenne"
        descriptionContent:
          type: array
          description: Nouveaux éléments de contenu (optionnel)
          items:
            $ref: '#/components/schemas/ContentItemDTO'

    # ------------------------------------------------------------------------
    # Schéma CommentRequest
    # ------------------------------------------------------------------------
    CommentRequest:
      type: object
      description: Requête d'ajout de commentaire
      required:
        - text
      properties:
        text:
          type: string
          description: Texte du commentaire
          minLength: 1
          maxLength: 1000
          example: "Investigation en cours - logs analysés"

    # ------------------------------------------------------------------------
    # Schémas pour l'authentification
    # ------------------------------------------------------------------------
    LoginRequest:
      type: object
      description: Requête de connexion
      required:
        - userID
      properties:
        userID:
          type: integer
          format: int32
          description: ID de l'utilisateur (simplification pour ce lab)
          example: 1

    AuthResponse:
      type: object
      description: Réponse d'authentification
      required:
        - token
        - user
      properties:
        token:
          type: string
          description: Token de session (ou ID de session)
          example: "session_abc123xyz"
        user:
          $ref: '#/components/schemas/UserDTO'

    # ------------------------------------------------------------------------
    # Schéma ErrorResponse (gestion des erreurs)
    # ------------------------------------------------------------------------
    ErrorResponse:
      type: object
      description: Réponse d'erreur standardisée
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Code d'erreur
          example: "INVALID_TRANSITION"
        message:
          type: string
          description: Message d'erreur détaillé
          example: "Transition invalide : Ouvert -> Termine. Transitions autorisées : ASSIGNE, FERME"
        details:
          type: object
          description: Détails supplémentaires (optionnel)
          additionalProperties: true

  # --------------------------------------------------------------------------
  # Schémas de sécurité
  # --------------------------------------------------------------------------
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Token d'authentification obtenu via POST /auth/login.

        Format: Authorization: Bearer <token>

        Exemple: Authorization: Bearer session_abc123xyz

  # --------------------------------------------------------------------------
  # Paramètres réutilisables
  # --------------------------------------------------------------------------
  parameters:
    TicketID:
      name: id
      in: path
      description: Identifiant unique du ticket
      required: true
      schema:
        type: integer
        format: int32
        example: 1001

    UserID:
      name: id
      in: path
      description: Identifiant unique de l'utilisateur
      required: true
      schema:
        type: integer
        format: int32
        example: 1

  # --------------------------------------------------------------------------
  # Réponses réutilisables
  # --------------------------------------------------------------------------
  responses:
    BadRequest:
      description: Requête invalide (validation échouée)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "VALIDATION_ERROR"
            message: "Le titre du ticket ne peut pas être vide"

    Unauthorized:
      description: Non authentifié (session invalide ou expirée)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "UNAUTHORIZED"
            message: "Session invalide ou expirée. Veuillez vous reconnecter."

    Forbidden:
      description: Accès refusé (permissions insuffisantes)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "FORBIDDEN"
            message: "Permissions insuffisantes pour cette opération"

    NotFound:
      description: Ressource non trouvée
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "NOT_FOUND"
            message: "Ticket #9999 introuvable"

    InternalServerError:
      description: Erreur interne du serveur
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "INTERNAL_ERROR"
            message: "Une erreur inattendue s'est produite"

# ============================================================================
# ENDPOINTS API (Phases 1.3 à 1.7)
# ============================================================================

# Sécurité par défaut pour tous les endpoints (sauf /auth/login)
security:
  - BearerAuth: []

paths:
  # ==========================================================================
  # AUTHENTIFICATION
  # ==========================================================================
  /auth/login:
    post:
      tags:
        - auth
      summary: Authentification utilisateur
      description: |
        Authentifie un utilisateur et retourne un token de session.
        Pour ce lab, l'authentification est simplifiée (ID utilisateur uniquement).
      operationId: login
      security: []  # Pas d'authentification requise pour se connecter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentification réussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/session:
    get:
      tags:
        - auth
      summary: Vérifier la session active
      description: Retourne l'utilisateur actuellement connecté
      operationId: getSession
      responses:
        '200':
          description: Session valide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDTO'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags:
        - auth
      summary: Déconnexion
      description: Invalide la session en cours
      operationId: logout
      responses:
        '204':
          description: Déconnexion réussie
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==========================================================================
  # UTILISATEURS
  # ==========================================================================
  /users:
    get:
      tags:
        - users
      summary: Liste tous les utilisateurs
      description: Retourne la liste complète des utilisateurs du système
      operationId: getAllUsers
      responses:
        '200':
          description: Liste des utilisateurs récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserDTO'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{id}:
    get:
      tags:
        - users
      summary: Détails d'un utilisateur
      description: Retourne les informations détaillées d'un utilisateur spécifique
      operationId: getUserById
      parameters:
        - $ref: '#/components/parameters/UserID'
      responses:
        '200':
          description: Utilisateur trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDTO'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================================================
  # TICKETS (CRUD)
  # ==========================================================================
  /tickets:
    get:
      tags:
        - tickets
      summary: Liste des tickets
      description: |
        Retourne la liste des tickets avec filtrage optionnel.
        Les utilisateurs normaux voient uniquement leurs tickets.
        Les admins et développeurs voient tous les tickets.
      operationId: getAllTickets
      parameters:
        - name: status
          in: query
          description: Filtrer par statut
          required: false
          schema:
            type: string
            enum:
              - Ouvert
              - Assigne
              - En validation
              - Termine
              - Ferme
        - name: assignedTo
          in: query
          description: Filtrer par utilisateur assigné (ID)
          required: false
          schema:
            type: integer
            format: int32
        - name: priority
          in: query
          description: Filtrer par priorité
          required: false
          schema:
            type: string
            enum:
              - Critique
              - Haute
              - Moyenne
              - Basse
      responses:
        '200':
          description: Liste des tickets récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TicketDTO'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - tickets
      summary: Créer un nouveau ticket
      description: |
        Crée un nouveau ticket. Tous les utilisateurs peuvent créer des tickets.
        Le créateur est automatiquement défini comme l'utilisateur connecté.
      operationId: createTicket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTicketRequest'
      responses:
        '201':
          description: Ticket créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDTO'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /tickets/{id}:
    get:
      tags:
        - tickets
      summary: Détails d'un ticket
      description: Retourne les informations complètes d'un ticket spécifique
      operationId: getTicketById
      parameters:
        - $ref: '#/components/parameters/TicketID'
      responses:
        '200':
          description: Ticket trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDTO'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - tickets
      summary: Modifier un ticket
      description: |
        Modifie un ticket existant.
        Les admins/développeurs peuvent modifier tous les tickets.
        Les utilisateurs ne peuvent modifier que leurs propres tickets.
      operationId: updateTicket
      parameters:
        - $ref: '#/components/parameters/TicketID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTicketRequest'
      responses:
        '200':
          description: Ticket modifié avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDTO'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - tickets
      summary: Supprimer un ticket
      description: |
        Supprime un ticket. Seuls les administrateurs peuvent supprimer des tickets.
      operationId: deleteTicket
      parameters:
        - $ref: '#/components/parameters/TicketID'
      responses:
        '204':
          description: Ticket supprimé avec succès
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================================================
  # COMMENTAIRES
  # ==========================================================================
  /tickets/{id}/comments:
    get:
      tags:
        - comments
      summary: Liste des commentaires d'un ticket
      description: Retourne tous les commentaires associés à un ticket
      operationId: getTicketComments
      parameters:
        - $ref: '#/components/parameters/TicketID'
      responses:
        '200':
          description: Liste des commentaires récupérée
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  description: Texte du commentaire
                example:
                  - "Investigation en cours - logs analysés"
                  - "Bug reproduit en environnement de test"
                  - "Correctif appliqué - en attente de validation"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - comments
      summary: Ajouter un commentaire
      description: |
        Ajoute un commentaire à un ticket.
        Admins et développeurs peuvent commenter tous les tickets.
      operationId: addComment
      parameters:
        - $ref: '#/components/parameters/TicketID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentRequest'
      responses:
        '201':
          description: Commentaire ajouté avec succès
          content:
            application/json:
              schema:
                type: string
                description: Le commentaire ajouté
                example: "Investigation en cours - logs analysés"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================================================
  # GESTION DES STATUTS
  # ==========================================================================
  /tickets/{id}/status:
    patch:
      tags:
        - status
      summary: Changer le statut d'un ticket
      description: |
        Modifie le statut d'un ticket avec validation des transitions.

        Transitions autorisées :
        - OUVERT → ASSIGNE, FERME
        - ASSIGNE → VALIDATION, FERME
        - VALIDATION → TERMINE, ASSIGNE
        - TERMINE/FERME → (états finaux, aucune transition)

        Seuls les admins et développeurs peuvent changer les statuts.
      operationId: updateTicketStatus
      parameters:
        - $ref: '#/components/parameters/TicketID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdateDTO'
      responses:
        '200':
          description: Statut modifié avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDTO'
        '400':
          description: Transition de statut invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "INVALID_TRANSITION"
                message: "Transition invalide : Ouvert -> Termine. Transitions autorisées : ASSIGNE, FERME"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      tags:
        - status
      summary: Obtenir les transitions disponibles
      description: Retourne la liste des statuts vers lesquels une transition est possible
      operationId: getAvailableTransitions
      parameters:
        - $ref: '#/components/parameters/TicketID'
      responses:
        '200':
          description: Liste des transitions disponibles
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                example:
                  - "ASSIGNE"
                  - "FERME"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================================================
  # ASSIGNATION
  # ==========================================================================
  /tickets/{id}/assignment:
    patch:
      tags:
        - tickets
      summary: Assigner un ticket à un utilisateur
      description: |
        Assigne un ticket à un utilisateur spécifique.
        Change automatiquement le statut du ticket à ASSIGNE.
        Seuls les admins peuvent assigner des tickets.
      operationId: assignTicket
      parameters:
        - $ref: '#/components/parameters/TicketID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignmentDTO'
      responses:
        '200':
          description: Ticket assigné avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDTO'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================================================
  # EXPORT
  # ==========================================================================
  /tickets/{id}/export/pdf:
    get:
      tags:
        - export
      summary: Exporter un ticket en PDF
      description: |
        Exporte le contenu d'un ticket en format PDF (simulé en texte).
        Utilise le pattern Strategy (PDFExporter) côté serveur.
      operationId: exportTicketToPDF
      parameters:
        - $ref: '#/components/parameters/TicketID'
      responses:
        '200':
          description: Export PDF généré avec succès
          content:
            text/plain:
              schema:
                type: string
                description: Contenu du PDF (format texte pour simulation)
                example: |
                  ==================================================
                       EXPORT PDF - TICKET DESCRIPTION
                  ==================================================

                  SECTION TEXTE
                  --------------------------------------------------
                  L'application crash lors de la connexion...
                  --------------------------------------------------

                  ==================================================
                       Fin du document PDF
                  ==================================================
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'
